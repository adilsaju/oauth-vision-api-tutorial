<html>
  <head>
    <style>
      #results {
	  position: fixed;
	  top: 50px;
	  left: 10px;
	  color: white;
      }

      #results span {
	  margin: 5px 5px;
      }
      
      video {
	  position: fixed;
	  top: 0;
	  left: 0;
      }

      h1 {
	  position: fixed;
	  bottom: 0;
	  left: 0;
      }

      button {
	  position: fixed;
	  top: 0;
	  left: 0;
      }
    </style>
  </head>
  <body>
    <!-- Basic Cloud Vision (Google) Demo -->

    <video autoplay="true" id="videoElement"></video>
    <button id="vision_button">Analyze</button>
    <div id='results'></div>
    
    <script>

      // Access camera 
      var video = document.querySelector("#videoElement");      
      if (navigator.mediaDevices.getUserMedia) {       
	  navigator.mediaDevices.getUserMedia({video: true})
	      .then(function(stream) {
		  video.srcObject = stream;
	      })
	      .catch(function(err) {
		  console.log("Something went wrong!");
	      });
      }
// Create canvas element once, outside of event listener
var canvas = document.createElement("canvas");

// Set canvas dimensions based on video dimensions
var scale = 0.25;
canvas.width = video.videoWidth * scale;
canvas.height = video.videoHeight * scale;

// Function to draw green rectangle around object
function drawBoundingBox(ctx, vertices) {
  ctx.beginPath();
  ctx.strokeStyle = "green";
  ctx.lineWidth = 2;
  ctx.moveTo(vertices[0].x, vertices[0].y);
  for (var i = 1; i < vertices.length; i++) {
    ctx.lineTo(vertices[i].x, vertices[i].y);
  }
  ctx.closePath();
  ctx.stroke();
}

// Event listener function
document.querySelector("#vision_button").addEventListener("click", (evt) => {
  // Draw video frame on canvas
  var contextOverlay = canvas.getContext("2d");
  contextOverlay.drawImage(video, 0, 0, canvas.width, canvas.height);

  // Send image to Google to analyze
  fetch("https://vision.googleapis.com/v1/images:annotate?key=AIzaSyD_7T7pGyVQqeJIBfhL-9nVhotOiy36_HM", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      requests: [
        {
          image: {
            content: canvas.toDataURL().split(",")[1],
          },
          features: [
            {
              type: "OBJECT_LOCALIZATION",
              maxResults: 10,
            },
          ],
        },
      ],
    }),
  })
    .then((resp) => {
      return resp.json();
    })
    .then((json) => {
      // Draw bounding boxes on canvas
      var contextOverlay = canvas.getContext("2d");
      contextOverlay.clearRect(0, 0, canvas.width, canvas.height);
      json.responses[0].localizedObjectAnnotations.forEach((obj) => {
        drawBoundingBox(contextOverlay, obj.boundingPoly.normalizedVertices);
      });

      // Output results
      console.log(json);
      results.innerHTML = "";
      json.responses[0].localizedObjectAnnotations.forEach((obj) => {
        let description = document.createElement("span");
        let score = document.createElement("span");

        let div = document.createElement("div");
        description.innerText = obj.name;
        score.innerText = obj.score;

        div.append(description, score);
        results.append(div);
      });
    });
});


      
    </script>
  </body>
</html>
